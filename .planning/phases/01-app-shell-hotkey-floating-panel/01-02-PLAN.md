---
phase: 01-app-shell-hotkey-floating-panel
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - QuickTask/QuickTask/Panel/FloatingPanel.swift
  - QuickTask/QuickTask/Panel/PanelManager.swift
  - QuickTask/QuickTask/App/AppDelegate.swift
autonomous: true
requirements:
  - SHELL-01
  - SHELL-03

must_haves:
  truths:
    - "Menu bar icon is visible in the macOS status bar at all times"
    - "Clicking the menu bar icon toggles a floating panel open and closed"
    - "Floating panel appears centered on screen in Spotlight-style positioning"
    - "Panel floats above all other windows"
    - "Text fields inside the panel can receive keyboard input"
    - "Menu bar icon persists after switching to other apps and returning"
  artifacts:
    - path: "QuickTask/QuickTask/Panel/FloatingPanel.swift"
      provides: "NSPanel subclass with non-activating floating behavior"
      contains: "class FloatingPanel"
      min_lines: 30
    - path: "QuickTask/QuickTask/Panel/PanelManager.swift"
      provides: "Singleton managing panel show/hide/toggle and screen positioning"
      contains: "class PanelManager"
    - path: "QuickTask/QuickTask/App/AppDelegate.swift"
      provides: "NSStatusItem strong reference and menu bar icon click handler"
      contains: "NSStatusItem"
  key_links:
    - from: "QuickTask/QuickTask/App/AppDelegate.swift"
      to: "QuickTask/QuickTask/Panel/PanelManager.swift"
      via: "Status item button action calls PanelManager.shared.toggle()"
      pattern: "PanelManager\\.shared\\.toggle"
    - from: "QuickTask/QuickTask/Panel/PanelManager.swift"
      to: "QuickTask/QuickTask/Panel/FloatingPanel.swift"
      via: "PanelManager owns FloatingPanel instance, calls orderFront/orderOut"
      pattern: "FloatingPanel"
    - from: "QuickTask/QuickTask/Panel/FloatingPanel.swift"
      to: "QuickTask/QuickTask/Views/ContentView.swift"
      via: "NSHostingView bridges SwiftUI ContentView into the panel"
      pattern: "NSHostingView"
---

<objective>
Build the NSStatusItem (menu bar icon), NSPanel subclass (FloatingPanel), and PanelManager (show/hide/toggle logic with screen centering). Wire the menu bar icon click to toggle the panel.

Purpose: This is the core architectural layer of QuickTask. The NSPanel subclass with correct style masks (.nonactivatingPanel, canBecomeKey, floating level) is the single most important implementation detail — getting it wrong means text fields don't work, the panel appears behind other apps, or focus management breaks. The NSStatusItem must be strongly retained on AppDelegate to prevent ARC from silently deallocating it.

Output: A visible menu bar icon that toggles a centered floating panel containing the placeholder ContentView.
</objective>

<execution_context>
@/home/rob/.claude/get-shit-done/workflows/execute-plan.md
@/home/rob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/phases/01-app-shell-hotkey-floating-panel/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FloatingPanel NSPanel subclass</name>
  <files>QuickTask/QuickTask/Panel/FloatingPanel.swift</files>
  <action>
Create `FloatingPanel.swift` — an NSPanel subclass that provides Spotlight-style floating behavior. This is approximately 50-70 lines.

Required configuration in `init`:
- `styleMask`: `[.nonactivatingPanel, .titled, .fullSizeContentView]` — `.nonactivatingPanel` is CRITICAL: it allows the panel to appear without activating the app and stealing focus from the user's current application
- `backing`: `.buffered`
- `defer`: `false`
- `isFloatingPanel = true` — ensures panel stays above regular windows
- `level = .floating` — window level above standard app windows
- `collectionBehavior` insert `.fullScreenAuxiliary` — allows panel to appear over fullscreen apps
- `collectionBehavior` insert `.transient` — panel not shown in Mission Control
- `titleVisibility = .hidden` — no title bar text
- `titlebarAppearsTransparent = true` — seamless look
- `isMovableByWindowBackground = true` — user can drag the panel
- `isReleasedWhenClosed = false` — CRITICAL: prevents ARC from releasing the panel when closed, which would crash on next toggle
- `hidesOnDeactivate = false` — panel should stay visible when user clicks elsewhere (dismissal is handled explicitly, not by auto-hide)
- `backgroundColor = .clear` (the SwiftUI content will provide its own background)
- `hasShadow = true`

Required overrides:
- `override var canBecomeKey: Bool { true }` — CRITICAL: without this, text fields inside the hosted SwiftUI view cannot receive keyboard input
- `override var canBecomeMain: Bool { false }` — prevents the panel from becoming the main window, which would interfere with the previous app's status

The init should accept a SwiftUI `Content: View` generic parameter and set `self.contentView = NSHostingView(rootView: content)`. Use `NSHostingView` to bridge the SwiftUI content into the AppKit panel.

Set the panel's initial content size to approximately `NSRect(x: 0, y: 0, width: 400, height: 300)` — this will be refined in Phase 2 when the actual UI is built.

Do NOT override `resignKey()` here — that will be added in Plan 03 for focus-return behavior.
  </action>
  <verify>
Project compiles with `swift build`. FloatingPanel class exists with all required style mask flags, canBecomeKey override, and NSHostingView bridging.
  </verify>
  <done>
FloatingPanel.swift exists with correct NSPanel subclass configuration: .nonactivatingPanel style mask, .floating level, canBecomeKey = true, canBecomeMain = false, NSHostingView content bridging, isReleasedWhenClosed = false.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PanelManager and wire NSStatusItem in AppDelegate</name>
  <files>
    QuickTask/QuickTask/Panel/PanelManager.swift
    QuickTask/QuickTask/App/AppDelegate.swift
  </files>
  <action>
**PanelManager.swift:**

Create a singleton `PanelManager` class that owns the `FloatingPanel` instance and manages show/hide/toggle:

- `static let shared = PanelManager()`
- Private `lazy var panel: FloatingPanel` — lazily creates the panel with `ContentView()` as the hosted SwiftUI view
- `var isVisible: Bool` — tracks panel state
- `func toggle()` — if visible, call `hide()`, else call `show()`
- `func show()`:
  1. Position the panel centered on the main screen: calculate center X and upper-third Y (Spotlight-style positioning — roughly 30% from top of screen)
     ```swift
     guard let screen = NSScreen.main else { return }
     let screenFrame = screen.visibleFrame
     let panelWidth: CGFloat = 400
     let panelHeight: CGFloat = 300
     let x = screenFrame.midX - panelWidth / 2
     let y = screenFrame.midY + screenFrame.height * 0.1  // Slightly above center, Spotlight-style
     panel.setFrame(NSRect(x: x, y: y, width: panelWidth, height: panelHeight), display: true)
     ```
  2. Call `panel.orderFrontRegardless()` to bring the panel to front even when app is not active — this is necessary because the app runs as .accessory
  3. Call `panel.makeKey()` (NOT `makeKeyAndOrderFront`) so text fields receive keyboard input without stealing full app activation
  4. Set `isVisible = true`
- `func hide()`:
  1. Call `panel.orderOut(nil)` to hide the panel
  2. Set `isVisible = false`

**AppDelegate.swift updates:**

Extend the existing AppDelegate to add the NSStatusItem:

- Add `private var statusItem: NSStatusItem!` — MUST be a strong instance property on AppDelegate. NOT a local variable. NOT a weak reference. ARC will silently deallocate a local or weak NSStatusItem and the menu bar icon will vanish (Pitfall 5 from research).
- In `applicationDidFinishLaunching(_:)`:
  1. Create the status item: `statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)`
  2. Configure the button:
     ```swift
     if let button = statusItem.button {
         button.image = NSImage(systemSymbolName: "checkmark.circle", accessibilityDescription: "QuickTask")
         button.action = #selector(togglePanel)
         button.target = self
     }
     ```
  3. Use SF Symbol "checkmark.circle" for now — Phase 3 will add a proper template image for light/dark menu bar support. SF Symbols work well as a starting point.
- Add `@objc func togglePanel()` method that calls `PanelManager.shared.toggle()`

IMPORTANT: The `statusItem` MUST be stored as an instance property on `AppDelegate`, not as a local variable in `applicationDidFinishLaunching`. This is the single most common cause of the "menu bar icon disappears" bug in macOS apps (research Pitfall 5).
  </action>
  <verify>
Run the app. Menu bar icon (checkmark.circle) is visible in the status bar. Clicking the icon shows the floating panel centered on screen with the placeholder ContentView text. Clicking the icon again hides the panel. Switch to another app (e.g., Terminal), verify the menu bar icon is still present. Click the icon from another app — panel appears above the other app's windows.
  </verify>
  <done>
Menu bar icon is visible and persists (SHELL-01). Clicking it toggles the floating panel which appears centered on screen in Spotlight-style positioning (SHELL-03). Panel floats above other windows. NSStatusItem is strongly retained on AppDelegate.
  </done>
</task>

</tasks>

<verification>
1. Menu bar icon is visible at all times (SHELL-01)
2. Clicking menu bar icon opens centered floating panel (SHELL-03)
3. Clicking menu bar icon again closes the panel
4. Panel appears above other application windows
5. Panel is positioned in Spotlight-style (centered, slightly above vertical center)
6. Switching to another app and back — menu bar icon still present
7. Text in the ContentView placeholder is readable inside the panel
</verification>

<success_criteria>
- Menu bar icon visible at all times, survives app switching (SHELL-01)
- Floating panel appears centered on screen when activated (SHELL-03)
- Panel uses NSPanel with .nonactivatingPanel, canBecomeKey = true, floating level
- NSStatusItem is strongly retained on AppDelegate
- PanelManager.toggle() works correctly from menu bar click
</success_criteria>

<output>
After completion, create `.planning/phases/01-app-shell-hotkey-floating-panel/01-02-SUMMARY.md`
</output>
