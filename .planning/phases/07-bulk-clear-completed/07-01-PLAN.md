---
phase: 07-bulk-clear-completed
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - QuickTask/Sources/Store/TaskStore.swift
  - QuickTask/Sources/Views/TaskListView.swift
autonomous: true
requirements:
  - CLEAR-01
  - CLEAR-02
  - CLEAR-03

must_haves:
  truths:
    - "A 'Clear N completed' button appears in the task panel footer when one or more completed tasks exist"
    - "Tapping the button shows a confirmation dialog before any tasks are removed"
    - "Confirming the dialog removes all completed tasks at once and the list updates immediately"
    - "The Clear button is completely absent (not disabled) when no completed tasks exist"
  artifacts:
    - path: "QuickTask/Sources/Store/TaskStore.swift"
      provides: "completedCount computed property and clearCompleted() mutation"
      contains: "func clearCompleted"
    - path: "QuickTask/Sources/Views/TaskListView.swift"
      provides: "Conditional footer button with confirmation dialog"
      contains: "confirmationDialog"
  key_links:
    - from: "QuickTask/Sources/Views/TaskListView.swift"
      to: "QuickTask/Sources/Store/TaskStore.swift"
      via: "store.completedCount drives button visibility and label; store.clearCompleted() called from dialog action"
      pattern: "store\\.completedCount|store\\.clearCompleted"
---

<objective>
Add a "Clear N completed" footer button to the task panel that removes all completed tasks in one action after user confirmation.

Purpose: Users currently delete completed tasks one by one. This adds a batch cleanup action behind a confirmation dialog, reducing friction for task list maintenance.
Output: Modified TaskStore.swift with completedCount + clearCompleted(), modified TaskListView.swift with conditional footer button and confirmationDialog.
</objective>

<execution_context>
@/home/rob/.claude/get-shit-done/workflows/execute-plan.md
@/home/rob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@QuickTask/Sources/Store/TaskStore.swift
@QuickTask/Sources/Views/TaskListView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add completedCount and clearCompleted() to TaskStore</name>
  <files>QuickTask/Sources/Store/TaskStore.swift</files>
  <action>
Add two items to TaskStore, following the existing patterns (incompleteCount, delete, move):

1. **Computed property `completedCount`** — add directly below the existing `incompleteCount` computed property in the `// MARK: - Computed Properties` section:

```swift
/// The count of tasks that have been completed.
/// Drives the "Clear N completed" button label and its conditional visibility in TaskListView.
/// The @Observable macro tracks reads of `tasks` here, so views reading this property
/// re-render whenever `tasks` mutates.
var completedCount: Int {
    tasks.filter { $0.isCompleted }.count
}
```

2. **Mutation `clearCompleted()`** — add at the end of the `// MARK: - Mutations` section, after the `move(fromOffsets:toOffset:)` method:

```swift
/// Removes all completed tasks in a single batch operation.
/// Uses removeAll(where:) for one in-place mutation + one persist() call.
/// Called only after user confirms the confirmation dialog in TaskListView.
func clearCompleted() {
    tasks.removeAll(where: { $0.isCompleted })
    persist()
}
```

**Critical constraints (locked decisions):**
- Single `removeAll(where:)` + single `persist()`. Do NOT loop over tasks calling `delete(_:)` (that would call persist() N times).
- `completedCount` must be a computed property on TaskStore (not computed inline in a View). This matches the `incompleteCount` pattern and ensures @Observable tracking works correctly.
  </action>
  <verify>Read TaskStore.swift and confirm: (1) `completedCount` computed property exists below `incompleteCount`, (2) `clearCompleted()` method exists in Mutations section, (3) `clearCompleted` uses `removeAll(where:)` not a loop, (4) exactly one `persist()` call in `clearCompleted`.</verify>
  <done>TaskStore has a `completedCount` computed property and a `clearCompleted()` mutation that removes all completed tasks in one batch with one persist() call.</done>
</task>

<task type="auto">
  <name>Task 2: Add conditional footer button with confirmation dialog to TaskListView</name>
  <files>QuickTask/Sources/Views/TaskListView.swift</files>
  <action>
Modify TaskListView to add a footer button with confirmation dialog. Three changes:

1. **Add `@State` property** — add below the existing `@Environment` line:

```swift
@State private var showConfirmation = false
```

2. **Add `.safeAreaInset(edge: .bottom)` modifier** — chain it on the `List` AFTER the existing `.overlay { ... }` modifier. This is a peer modifier on the List, not nested inside the overlay:

```swift
.safeAreaInset(edge: .bottom) {
    if store.completedCount > 0 {
        HStack {
            Spacer()
            Button("Clear \(store.completedCount) completed") {
                showConfirmation = true
            }
            .buttonStyle(.plain)
            .foregroundStyle(.secondary)
            .padding(.vertical, 8)
            Spacer()
        }
        .background(.regularMaterial)
    }
}
```

3. **Add `.confirmationDialog` modifier** — attach it to the `List` itself (NOT inside the conditional `if` block — placing it on the always-present List avoids SwiftUI removing the dialog modifier when the button disappears). Chain it AFTER the `.safeAreaInset` modifier:

```swift
.confirmationDialog(
    "Clear completed tasks?",
    isPresented: $showConfirmation
) {
    Button("Clear \(store.completedCount) completed", role: .destructive) {
        store.clearCompleted()
    }
} message: {
    Text("This will permanently remove all completed tasks.")
}
```

**The final modifier chain on List should be:**
1. `.listStyle(.plain)`
2. `.overlay { ... }` (existing empty state)
3. `.safeAreaInset(edge: .bottom) { ... }` (new footer)
4. `.confirmationDialog(...)` (new dialog)

**Critical constraints:**
- The button is rendered ONLY when `store.completedCount > 0` via `if` — NOT `.disabled()`. CLEAR-03 requires the button be ABSENT, not disabled.
- `@State private var showConfirmation` lives in TaskListView — NOT in TaskStore (data store should not hold UI state) and NOT in ContentView (unnecessary coupling).
- Use `.confirmationDialog` (locked decision) — NOT `.alert`.
- `safeAreaInset(edge: .bottom)` preserves full List height — do NOT wrap List in a VStack with a bottom bar.
  </action>
  <verify>Read TaskListView.swift and confirm: (1) `@State private var showConfirmation` exists, (2) `.safeAreaInset(edge: .bottom)` modifier on List contains conditional button, (3) `.confirmationDialog` modifier on List with destructive button calling `store.clearCompleted()`, (4) button wrapped in `if store.completedCount > 0` (conditional rendering, not disabled), (5) no VStack wrapper around List.</verify>
  <done>TaskListView shows a "Clear N completed" footer button only when completed tasks exist, presents a confirmation dialog on tap, and calls store.clearCompleted() on confirmation. Button is absent (not disabled) when no completed tasks exist.</done>
</task>

</tasks>

<verification>
1. Read TaskStore.swift — verify `completedCount` computed property and `clearCompleted()` mutation exist with correct implementation
2. Read TaskListView.swift — verify `@State showConfirmation`, `safeAreaInset` footer with conditional button, and `confirmationDialog` modifier on List
3. Verify no new files were created — only two existing files modified
4. Verify no new dependencies added — all APIs are SwiftUI stdlib
5. Hardware validation note: `confirmationDialog` in `.nonactivatingPanel` context should be tested on macOS. If dialog does not appear, fallback is `NSAlert.runModal()` — but this is a post-phase concern, not a blocker for code completion
</verification>

<success_criteria>
- TaskStore.completedCount returns the count of completed tasks, reactively tracked by @Observable
- TaskStore.clearCompleted() removes all completed tasks in one removeAll + one persist()
- TaskListView footer shows "Clear N completed" button ONLY when completedCount > 0
- Tapping button sets showConfirmation = true, presenting a confirmationDialog
- Dialog has a destructive "Clear N completed" action that calls store.clearCompleted()
- After clearing, button disappears (completedCount becomes 0) and task list updates immediately
- No new files, no new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/07-bulk-clear-completed/07-01-SUMMARY.md`
</output>
