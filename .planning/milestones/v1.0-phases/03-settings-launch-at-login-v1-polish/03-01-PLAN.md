---
phase: 03-settings-launch-at-login-v1-polish
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - QuickTask/Package.swift
  - QuickTask/Sources/App/QuickTaskApp.swift
  - QuickTask/Sources/App/AppDelegate.swift
  - QuickTask/Sources/Settings/SettingsView.swift
autonomous: true
requirements: [SETT-01, SETT-02]

must_haves:
  truths:
    - "Right-clicking the menu bar icon shows a context menu with Settings... and Quit QuickTask"
    - "Left-clicking the menu bar icon still toggles the floating panel (existing behavior preserved)"
    - "Selecting Settings... from the context menu opens a Settings window"
    - "Settings window contains a Launch at Login toggle that defaults to off"
    - "Toggling Launch at Login calls SMAppService.mainApp.register() or .unregister()"
    - "Launch at Login state is read from SMAppService.mainApp.status at runtime, not stored in Defaults"
    - "Menu bar icon uses a template image for correct light/dark tinting"
  artifacts:
    - path: "QuickTask/Sources/Settings/SettingsView.swift"
      provides: "Settings UI with Launch at Login toggle"
      contains: "SMAppService.mainApp"
    - path: "QuickTask/Sources/App/QuickTaskApp.swift"
      provides: "Hidden Window scene before Settings scene"
      contains: "hidden-settings-bridge"
    - path: "QuickTask/Sources/App/AppDelegate.swift"
      provides: "Right-click context menu, openSettings notification, template image"
      contains: "sendAction(on:"
    - path: "QuickTask/Package.swift"
      provides: "Defaults SPM dependency"
      contains: "Defaults"
  key_links:
    - from: "QuickTask/Sources/App/AppDelegate.swift"
      to: "QuickTask/Sources/App/QuickTaskApp.swift"
      via: "NotificationCenter post .openSettingsRequest"
      pattern: "openSettingsRequest"
    - from: "QuickTask/Sources/App/QuickTaskApp.swift"
      to: "Settings scene"
      via: "@Environment(\\.openSettings) in HiddenWindowView"
      pattern: "openSettings"
    - from: "QuickTask/Sources/Settings/SettingsView.swift"
      to: "ServiceManagement framework"
      via: "SMAppService.mainApp.register/unregister/status"
      pattern: "SMAppService\\.mainApp"
---

<objective>
Add a Settings window accessible via right-click context menu on the menu bar icon, containing a Launch at Login toggle backed by SMAppService, and make the menu bar icon a proper template image.

Purpose: SETT-01 and SETT-02 are the final functional requirements for v1. The Settings window provides a discoverable surface for preferences, and Launch at Login ensures the app survives reboots without user action.

Output: Working Settings window with Launch at Login toggle, right-click context menu on the menu bar icon, template image for light/dark menu bar support.
</objective>

<execution_context>
@/home/rob/.claude/get-shit-done/workflows/execute-plan.md
@/home/rob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-launch-at-login-v1-polish/03-RESEARCH.md
@QuickTask/Sources/App/QuickTaskApp.swift
@QuickTask/Sources/App/AppDelegate.swift
@QuickTask/Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Defaults dependency, create SettingsView, and restructure App body with hidden Window scene</name>
  <files>
    QuickTask/Package.swift
    QuickTask/Sources/Settings/SettingsView.swift
    QuickTask/Sources/App/QuickTaskApp.swift
  </files>
  <action>
**Package.swift** -- Add Defaults 9.0.0 SPM dependency:
- Add `.package(url: "https://github.com/sindresorhus/Defaults", from: "9.0.0")` to the `dependencies` array
- Add `"Defaults"` to the target's `dependencies` array alongside `"KeyboardShortcuts"`

**SettingsView.swift** -- Create new file at `QuickTask/Sources/Settings/SettingsView.swift`:
- `import SwiftUI` and `import ServiceManagement`
- `struct SettingsView: View` with `@State private var launchAtLogin = false`
- Body: `Form` with `.formStyle(.grouped)` containing a `Section` with header "General"
- Inside the section: `Toggle("Launch at login", isOn: $launchAtLogin)` with `.onChange(of: launchAtLogin)` handler
- The onChange handler: if newValue is true, call `try SMAppService.mainApp.register()`, else `try SMAppService.mainApp.unregister()`. Wrap in do/catch; on error, revert `launchAtLogin = !newValue`
- Below the toggle, conditionally show `Text("Approval required in System Settings > General > Login Items")` with `.font(.caption).foregroundStyle(.secondary)` when `SMAppService.mainApp.status == .requiresApproval`
- `.onAppear`: set `launchAtLogin = SMAppService.mainApp.status == .enabled`
- Frame: `.frame(width: 400, minHeight: 150)`
- Add `.padding()` to the Form
- Do NOT store launch-at-login state in Defaults -- always query SMAppService.mainApp.status
- Add `#if DEBUG` guard around the register/unregister calls with a comment explaining SMAppService may fail in dev builds without proper app bundle identity. In DEBUG, print a warning instead of calling register/unregister.

**QuickTaskApp.swift** -- Restructure the App body to support Settings window opening from AppKit:
- Add `Notification.Name` extension at the top of the file (outside the struct): `static let openSettingsRequest = Notification.Name("OpenSettingsRequest")`
- Create a `struct HiddenWindowView: View` with `@Environment(\.openSettings) private var openSettings`
- HiddenWindowView body: `Color.clear.frame(width: 1, height: 1)` with `.onReceive(NotificationCenter.default.publisher(for: .openSettingsRequest))` that runs a `Task { @MainActor in ... }` block
- Inside the Task block: `NSApp.setActivationPolicy(.regular)`, `try? await Task.sleep(for: .milliseconds(100))`, `NSApp.activate(ignoringOtherApps: true)`, `openSettings()`, `try? await Task.sleep(for: .milliseconds(200))`, `NSApp.setActivationPolicy(.accessory)`
- In the QuickTaskApp body, declare scenes in this EXACT order:
  1. `Window("", id: "hidden-settings-bridge") { HiddenWindowView() }` with `.windowResizability(.contentSize)` and `.defaultSize(width: 1, height: 1)`
  2. `Settings { SettingsView() }`
- Remove the old `Settings { EmptyView() }` scene
  </action>
  <verify>
- File `QuickTask/Sources/Settings/SettingsView.swift` exists and contains `SMAppService.mainApp`
- File `QuickTask/Sources/App/QuickTaskApp.swift` contains `hidden-settings-bridge` BEFORE `Settings {`
- File `QuickTask/Package.swift` contains `Defaults` in both package-level and target-level dependencies
- Grep for `openSettingsRequest` in QuickTaskApp.swift confirms notification name is defined
- Grep for `openSettings()` in QuickTaskApp.swift confirms environment action is called
- No occurrence of `Defaults[` or `@Default` for launch-at-login state (it uses SMAppService.mainApp.status)
  </verify>
  <done>
SettingsView exists with SMAppService-backed Launch at Login toggle. QuickTaskApp.swift has hidden Window scene declared first, then Settings scene with SettingsView. Defaults SPM dependency added to Package.swift.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add right-click context menu to NSStatusItem and make icon a template image</name>
  <files>
    QuickTask/Sources/App/AppDelegate.swift
  </files>
  <action>
**AppDelegate.swift** -- Modify to support both left-click (panel toggle) and right-click (context menu):

1. Add `NSEvent` extension (can be at the bottom of the file or in a separate extension block):
```swift
extension NSEvent {
    var isRightClick: Bool {
        type == .rightMouseDown || modifierFlags.contains(.control)
    }
}
```

2. Modify `setupStatusItem()`:
- After creating the status item button image, explicitly set `image.isTemplate = true` (SF Symbols should be template by default, but set explicitly per phase constraint)
- Change `button.action = #selector(togglePanel)` to `button.action = #selector(handleStatusItemClick)`
- Add `button.sendAction(on: [.leftMouseDown, .rightMouseDown])` to intercept both click types
- Keep `button.target = self`

3. Replace `@objc private func togglePanel()` with `@objc private func handleStatusItemClick()`:
- Read `NSApp.currentEvent` and check `isRightClick`
- If right-click: call `showContextMenu()`
- If left-click: call `PanelManager.shared.toggle()` (existing behavior)

4. Add `private func showContextMenu()`:
- Create `NSMenu()`
- Add `NSMenuItem(title: "Settings...", action: #selector(openSettingsFromMenu), keyEquivalent: ",")` with `target = self`
- Add `NSMenuItem.separator()`
- Add `NSMenuItem(title: "Quit QuickTask", action: #selector(NSApplication.terminate(_:)), keyEquivalent: "q")`
- Pop up the menu at the status item button location: get button frame, call `menu.popUp(positioning: nil, at: ..., in: button)` -- use `button.window` for the `in:` parameter

5. Add `@objc private func openSettingsFromMenu()`:
- Post `NotificationCenter.default.post(name: .openSettingsRequest, object: nil)`

6. Also in `applicationDidFinishLaunching`, after `setupStatusItem()`, add a `DispatchQueue.main.async` block that finds and hides the hidden helper window:
```swift
DispatchQueue.main.async {
    if let window = NSApp.windows.first(where: { $0.identifier?.rawValue == "hidden-settings-bridge" }) {
        window.orderOut(nil)
    }
}
```
This prevents the 1x1 hidden window from being visible (Pitfall 4 from research).

Do NOT set `statusItem.menu` -- this would override the button action and break left-click panel toggle.
  </action>
  <verify>
- Grep for `sendAction(on:` in AppDelegate.swift confirms both click types are intercepted
- Grep for `isRightClick` in AppDelegate.swift confirms right-click detection
- Grep for `showContextMenu` in AppDelegate.swift confirms context menu method exists
- Grep for `openSettingsRequest` in AppDelegate.swift confirms notification is posted
- Grep for `isTemplate = true` in AppDelegate.swift confirms template image is set
- Grep for `Settings\\.\\.\\.` or `"Settings..."` in AppDelegate.swift confirms menu item text
- No occurrence of `statusItem.menu =` in AppDelegate.swift (would break left-click)
- `handleStatusItemClick` exists and `togglePanel` selector is removed
  </verify>
  <done>
Right-clicking the menu bar icon shows a context menu with "Settings..." and "Quit QuickTask". Left-clicking continues to toggle the floating panel. Selecting "Settings..." posts the openSettingsRequest notification which triggers the hidden window bridge to open the Settings scene. Menu bar icon explicitly uses template image for light/dark support. Hidden helper window is ordered out on launch.
  </done>
</task>

</tasks>

<verification>
1. Grep for `SMAppService.mainApp` in SettingsView.swift -- confirms launch-at-login uses Apple's API
2. Grep for `hidden-settings-bridge` in QuickTaskApp.swift -- confirms hidden window exists
3. Grep for `sendAction(on:` in AppDelegate.swift -- confirms dual-click support
4. Grep for `openSettingsRequest` across all Swift files -- confirms notification bridge is wired (AppDelegate posts, QuickTaskApp receives)
5. Grep for `statusItem.menu` in AppDelegate.swift -- must NOT exist (would break left-click)
6. Grep for `isTemplate` in AppDelegate.swift -- confirms template image
7. Verify Package.swift contains `Defaults` dependency
8. Verify no `Defaults[` or `@Default` key stores launch-at-login state
</verification>

<success_criteria>
- SettingsView.swift exists with SMAppService-backed Launch at Login toggle (SETT-01)
- AppDelegate has right-click context menu with "Settings..." item (SETT-02)
- QuickTaskApp.swift has hidden Window scene (first) + Settings scene (second)
- Notification bridge connects AppDelegate right-click to SwiftUI openSettings()
- Menu bar icon is explicitly template image
- Defaults SPM dependency added (ready for future preferences)
- No statusItem.menu assignment (left-click panel toggle preserved)
- No local storage of launch-at-login state (SMAppService.mainApp.status is source of truth)
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-launch-at-login-v1-polish/03-01-SUMMARY.md`
</output>
