---
phase: 01-app-shell-hotkey-floating-panel
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - QuickTask/Sources/Hotkey/HotkeyService.swift
  - QuickTask/Sources/Panel/FloatingPanel.swift
  - QuickTask/Sources/Panel/PanelManager.swift
  - QuickTask/Sources/App/AppDelegate.swift
autonomous: false
requirements:
  - SHELL-04
  - SHELL-05
  - HKEY-01
  - HKEY-02
  - HKEY-03
  - HKEY-04

must_haves:
  truths:
    - "Pressing Cmd+Shift+Space from any app opens the floating panel"
    - "Pressing Cmd+Shift+Space again closes the panel"
    - "Pressing Escape while the panel is open closes it"
    - "Clicking outside the panel closes it"
    - "After panel dismissal, keyboard focus returns to the previously active app"
    - "Panel appears within 200ms of hotkey press (no perceptible lag)"
  artifacts:
    - path: "QuickTask/Sources/Hotkey/HotkeyService.swift"
      provides: "Global hotkey registration using KeyboardShortcuts library"
      contains: "KeyboardShortcuts"
      min_lines: 15
    - path: "QuickTask/Sources/Panel/FloatingPanel.swift"
      provides: "resignKey override for focus-return and Escape key handling"
      contains: "resignKey"
    - path: "QuickTask/Sources/Panel/PanelManager.swift"
      provides: "Focus-return logic storing previous app, click-outside monitor"
      contains: "previousApp"
  key_links:
    - from: "QuickTask/Sources/Hotkey/HotkeyService.swift"
      to: "QuickTask/Sources/Panel/PanelManager.swift"
      via: "KeyboardShortcuts.onKeyUp triggers PanelManager.shared.toggle()"
      pattern: "PanelManager\\.shared\\.toggle"
    - from: "QuickTask/Sources/Panel/FloatingPanel.swift"
      to: "QuickTask/Sources/Panel/PanelManager.swift"
      via: "resignKey() calls PanelManager.shared.hide()"
      pattern: "PanelManager\\.shared\\.hide"
    - from: "QuickTask/Sources/Panel/PanelManager.swift"
      to: "NSRunningApplication"
      via: "Stores and reactivates previous frontmost app on dismiss"
      pattern: "NSWorkspace\\.shared\\.frontmostApplication"
---

<objective>
Wire the global hotkey (Cmd+Shift+Space) using KeyboardShortcuts library, implement Escape-to-dismiss, click-outside-to-dismiss, and focus-return-to-previous-app behavior. This completes all Phase 1 requirements.

Purpose: The global hotkey is the core value proposition of QuickTask — "one hotkey and a few keystrokes saves a task." If the hotkey does not fire from background apps, if Escape does not dismiss, if clicking outside does not close the panel, or if the user's previous app loses focus permanently, the entire experience fails. These behaviors must work correctly together as a system.

Output: A fully functional app shell where the hotkey toggles the panel from any app, all dismissal paths work, and focus returns cleanly.
</objective>

<execution_context>
@/home/rob/.claude/get-shit-done/workflows/execute-plan.md
@/home/rob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/phases/01-app-shell-hotkey-floating-panel/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register global hotkey and implement HotkeyService</name>
  <files>
    QuickTask/Sources/Hotkey/HotkeyService.swift
    QuickTask/Sources/App/AppDelegate.swift
  </files>
  <action>
**HotkeyService.swift:**

Create the global hotkey registration using KeyboardShortcuts SPM library (NOT SwiftUI .keyboardShortcut() which does not fire when backgrounded — Pitfall 1):

1. Define the shortcut name as an extension:
   ```swift
   import KeyboardShortcuts

   extension KeyboardShortcuts.Name {
       static let togglePanel = Self("togglePanel", default: .init(.space, modifiers: [.command, .shift]))
   }
   ```
   Default hotkey: Cmd+Shift+Space. This avoids conflicts with Spotlight (Cmd+Space), screenshots (Cmd+Shift+3/4/5), and other common system shortcuts per the blocker concern in STATE.md.

2. Create `HotkeyService` class:
   ```swift
   final class HotkeyService {
       static let shared = HotkeyService()

       func register() {
           KeyboardShortcuts.onKeyUp(for: .togglePanel) { [weak self] in
               PanelManager.shared.toggle()
           }
       }
   }
   ```
   Use `onKeyUp` (not `onKeyDown`) — this is the standard pattern for toggle shortcuts. KeyboardShortcuts handles the Carbon/CGEventTap internals correctly, including Input Monitoring permissions (not Accessibility — research Pitfall 6).

**AppDelegate.swift updates:**

In `applicationDidFinishLaunching(_:)`, add after the NSStatusItem setup:
```swift
HotkeyService.shared.register()
```

This must happen at launch so the hotkey is active immediately. The KeyboardShortcuts library handles the lifecycle (deregistration on app quit) automatically.
  </action>
  <verify>
Build and run the app with `cd /home/rob/projects/todo-app/QuickTask && swift build && swift run QuickTask &`. Switch to another application (e.g., Finder or Terminal). Press Cmd+Shift+Space. The floating panel should appear. Press Cmd+Shift+Space again — panel should hide. The hotkey should work regardless of which app is in the foreground.
  </verify>
  <done>
Global hotkey Cmd+Shift+Space toggles the panel from any application (HKEY-01, HKEY-02). Panel appears promptly on keypress (HKEY-03 — sub-200ms since panel is pre-created and only needs orderFront).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Escape dismiss, click-outside dismiss, and focus-return</name>
  <files>
    QuickTask/Sources/Panel/FloatingPanel.swift
    QuickTask/Sources/Panel/PanelManager.swift
  </files>
  <action>
This task implements three interrelated dismissal behaviors. They must work together correctly.

**PanelManager.swift updates — focus-return and click-outside:**

1. Add a property to store the previously active application:
   ```swift
   private var previousApp: NSRunningApplication?
   ```

2. Update `show()` to capture the frontmost app BEFORE showing the panel:
   ```swift
   func show() {
       // Capture before showing — once our panel is key, frontmostApplication changes
       previousApp = NSWorkspace.shared.frontmostApplication

       // ... existing positioning and orderFront code ...
   }
   ```

3. Update `hide()` to return focus to the previous app:
   ```swift
   func hide() {
       panel.orderOut(nil)
       isVisible = false

       // Return focus to the app that was active before the panel appeared
       previousApp?.activate(options: [])
       previousApp = nil
   }
   ```
   Use `.activate(options: [])` (empty options) rather than `.activate(options: .activateIgnoringOtherApps)` — the gentle activation is sufficient since we just hid our panel. The `options: []` form was introduced in macOS 14 to replace the deprecated `activate(ignoringOtherApps:)`.

4. Add a click-outside event monitor. In `show()`, install a global and local event monitor for mouse clicks:
   ```swift
   private var clickMonitor: Any?

   func show() {
       // ... existing code ...

       // Monitor for clicks outside the panel to dismiss
       clickMonitor = NSEvent.addGlobalMonitorForEvents(matching: [.leftMouseDown, .rightMouseDown]) { [weak self] event in
           guard let self, self.isVisible else { return }
           self.hide()
       }
   }

   func hide() {
       // Remove the click monitor
       if let monitor = clickMonitor {
           NSEvent.removeMonitor(monitor)
           clickMonitor = nil
       }

       // ... existing hide code ...
   }
   ```
   Use `addGlobalMonitorForEvents` (not `addLocalMonitorForEvents`) because we need to detect clicks in OTHER applications' windows. The global monitor fires when the user clicks anywhere outside our app's windows. We do NOT need a local monitor here because clicking within our panel should not dismiss it.

**FloatingPanel.swift updates — Escape key and resignKey:**

1. Override `keyDown(with:)` to handle Escape:
   ```swift
   override func keyDown(with event: NSEvent) {
       if event.keyCode == 53 { // 53 = Escape key
           PanelManager.shared.hide()
       } else {
           super.keyDown(with: event)
       }
   }
   ```
   keyCode 53 is the Escape key. Pass all other keys to super so normal text input works.

2. Override `resignKey()` to handle focus loss:
   ```swift
   override func resignKey() {
       super.resignKey()
       // When the panel loses key status (user clicked elsewhere or app deactivated),
       // hide the panel. PanelManager.hide() handles focus-return.
       if isVisible {
           PanelManager.shared.hide()
       }
   }
   ```
   NOTE: Be careful about the interaction between resignKey and the click-outside monitor. When the user clicks outside, both the global monitor AND resignKey may fire. PanelManager.hide() must be idempotent — calling it when already hidden should be a no-op. Add a guard at the top of hide():
   ```swift
   func hide() {
       guard isVisible else { return }
       // ... rest of hide logic
   }
   ```

IMPORTANT INTERACTION: The `resignKey()` override means the panel will auto-dismiss when it loses key window status. This covers click-outside dismissal as a backup. However, the global event monitor is still needed because `resignKey()` may not fire in all cases (e.g., when clicking on another app's window in certain macOS configurations). Keep both mechanisms, with `hide()` being idempotent.
  </action>
  <verify>
Build and run with `cd /home/rob/projects/todo-app/QuickTask && swift build && swift run QuickTask &`. Test all dismissal paths in sequence:
1. Press Cmd+Shift+Space to open panel. Press Escape — panel closes, previous app regains focus.
2. Press Cmd+Shift+Space to open panel. Click on the Desktop or another app window — panel closes, clicked app has focus.
3. Press Cmd+Shift+Space to open panel. Press Cmd+Shift+Space again — panel closes (toggle behavior).
4. Open panel from one app (e.g., Terminal), dismiss, verify Terminal regains focus (cursor blinks in Terminal).
5. Open panel from a different app (e.g., Finder), dismiss, verify Finder regains focus.
  </verify>
  <done>
Escape key dismisses the panel (SHELL-04). Clicking outside dismisses the panel (SHELL-05). Focus returns to the previously active app after any dismissal method (HKEY-04). All dismissal paths are idempotent — double-dismiss does not crash or cause unexpected behavior.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 behavior</name>
  <what-built>
Complete app shell with menu bar icon, floating panel, global hotkey (Cmd+Shift+Space), and all dismissal behaviors (Escape, click-outside, hotkey toggle). Focus returns to the previous app on every dismiss path.
  </what-built>
  <how-to-verify>
Build and run the QuickTask app with `cd /home/rob/projects/todo-app/QuickTask && swift build && swift run QuickTask`. Verify each behavior:

1. **SHELL-01 (Menu bar icon):** Look for the checkmark.circle icon in the macOS status bar. It should be visible. Switch to other apps and back — icon persists.

2. **SHELL-02 (No Dock icon):** Confirm QuickTask does NOT appear in the Dock. Check Activity Monitor to confirm it is running.

3. **SHELL-03 (Floating panel):** Click the menu bar icon. A floating panel should appear centered on screen, slightly above vertical center (Spotlight-style). It should float above other windows.

4. **SHELL-04 (Escape dismiss):** With the panel open, press Escape. Panel should close.

5. **SHELL-05 (Click-outside dismiss):** Open the panel via hotkey. Click anywhere outside the panel (another app window, Desktop). Panel should close.

6. **HKEY-01 + HKEY-02 (Global hotkey):** Switch to Safari, Terminal, or Finder. Press Cmd+Shift+Space. The panel should appear even though QuickTask is not the active app. Press Cmd+Shift+Space again to close.

7. **HKEY-03 (Latency):** Press the hotkey repeatedly. Panel should appear near-instantly (no perceptible delay).

8. **HKEY-04 (Focus return):** Open Terminal and type something. Press Cmd+Shift+Space (panel opens). Press Escape (panel closes). Your cursor should be back in Terminal, ready to type — no need to click Terminal again.
  </how-to-verify>
  <resume-signal>Type "approved" if all 8 checks pass. If any fail, describe which check failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
1. Cmd+Shift+Space toggles panel from any app (HKEY-01, HKEY-02)
2. Panel appears within 200ms — no perceptible delay (HKEY-03)
3. Escape key closes the panel (SHELL-04)
4. Clicking outside the panel closes it (SHELL-05)
5. Focus returns to previous app after dismiss via any method (HKEY-04)
6. Menu bar icon still visible (SHELL-01, from Plan 02)
7. No Dock icon (SHELL-02, from Plan 01)
8. Panel centered on screen (SHELL-03, from Plan 02)
</verification>

<success_criteria>
- All 9 Phase 1 requirements (SHELL-01 through SHELL-05, HKEY-01 through HKEY-04) are satisfied
- Global hotkey works from any app using KeyboardShortcuts library
- All three dismissal methods work: Escape, click-outside, hotkey toggle
- Focus returns to previous app after every dismissal path
- No crashes or unexpected behavior from double-dismiss or rapid toggling
</success_criteria>

<output>
After completion, create `.planning/phases/01-app-shell-hotkey-floating-panel/01-03-SUMMARY.md`
</output>
